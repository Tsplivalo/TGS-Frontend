<section class="stack-lg">

  <!-- Card principal con título, toolbar, filtros, mensajes y listado -->
  <div class="glass-dark card stack-md">
    <header class="header">
      <h2 class="title">{{ 'partner.title' | translate }}</h2>
      <div class="right">
        <button class="btn" type="button" (click)="toggleNew()" [attr.aria-expanded]="isNewOpen()">
          {{ isNewOpen() ? ('common.close' | translate) : ('partner.new' | translate) }}
        </button>
      </div>
    </header>

    <!-- Filtros -->
    <section class="filters">
      <label class="label">
        <span>{{ 'partner.filters.search' | translate }}</span>
        <input class="input" type="text" [ngModel]="fText()" (ngModelChange)="fText.set($event)"
          [placeholder]="'partner.filters.searchPh' | translate" />
      </label>
    </section>

    <!-- Mensajes de estado -->
    <div class="error" *ngIf="error() as err"><strong>{{ 'common.error' | translate }}:</strong> {{ err }}</div>
    <div class="muted" *ngIf="loading()">{{ 'partner.loading' | translate }}</div>

    <!-- Listado -->
    <section class="subsection">
      <h3 class="sub-title">{{ 'partner.list' | translate }}</h3>

      <div class="table-wrap" *ngIf="filtered().length; else emptyState">
        <table class="table">
          <thead>
            <tr>
              <th style="width:140px;">{{ 'partner.table.dni' | translate }}</th>
              <th>{{ 'partner.table.name' | translate }}</th>
              <th>{{ 'partner.table.email' | translate }}</th>
              <th style="width:140px;">{{ 'partner.table.phone' | translate }}</th>
              <th>{{ 'partner.table.address' | translate }}</th>
              <th>{{ 'decisions.title' | translate }}</th>
              <th class="right" style="width:180px;">{{ 'partner.table.actions' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of filtered(); trackBy: trackByDni">
              <td class="mono">#{{ it.dni }}</td>
              <td>{{ it.name }}</td>
              <td class="truncate">{{ it.email || '—' }}</td>
              <td class="truncate">{{ it.phone || '—' }}</td>
              <td class="truncate">{{ it.address || '—' }}</td>
              <td>
                <ul class="chips" *ngIf="it.decisions?.length; else noDecisions">
                  <li class="chip" *ngFor="let d of it.decisions">
                    <span class="mono">#{{ d.id }}</span> — {{ d.description || '—' }}
                    <button class="chip__btn" type="button" (click)="detachDecision(it, d)"
                      [title]="'common.delete' | translate">×</button>
                  </li>
                </ul>
                <ng-template #noDecisions><span class="muted">—</span></ng-template>

                <!-- Adjuntar decisión por ID -->
                <div class="attach">
                  <input class="input" type="number" [formControl]="decisionIdToAttach" placeholder="Decision ID" />
                  <button class="btn" type="button" (click)="attachDecision(it)">
                    {{ 'store.add' | translate }}
                  </button>
                </div>
              </td>
              <td class="right">
                <button class="btn ghost btn--icon" type="button" (click)="edit(it)"
                  [title]="'common.edit' | translate">
                  ✏️ <span class="sr-only">{{ 'common.edit' | translate }}</span>
                </button>
                <button class="btn danger btn--icon" type="button" (click)="delete(it)"
                  [title]="'common.delete' | translate">
                  🗑️ <span class="sr-only">{{ 'common.delete' | translate }}</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty state -->
      <ng-template #emptyState>
        <div class="empty empty-state">
          <h3>{{ 'partner.emptyTitle' | translate }}</h3>
          <p class="muted">{{ 'partner.emptyHint' | translate }}</p>
        </div>
      </ng-template>
    </section>
  </div>

  <!-- Panel colapsable crear/editar (la tabla queda visible arriba) -->
  <div class="collapsible" [class.open]="isNewOpen()">
    <div class="collapsible__content glass-dark card">
      <div class="header">
        <h2 class="title">
          {{ isEdit()
          ? ('partner.editTitle' | translate:{ dni: (form.value.dni || '') })
          : ('partner.newTitle' | translate) }}
        </h2>
      </div>

      <form [formGroup]="form" class="form-grid" (ngSubmit)="save()">
        <label class="label">
          <span>{{ 'partner.form.dni' | translate }}</span>
          <input class="input" type="text" formControlName="dni" [readonly]="isEdit()" />
        </label>

        <label class="label">
          <span>{{ 'partner.form.name' | translate }}</span>
          <input class="input" type="text" formControlName="name" />
        </label>

        <label class="label">
          <span>{{ 'partner.form.email' | translate }}</span>
          <input class="input" type="email" formControlName="email" />
        </label>

        <label class="label">
          <span>{{ 'partner.form.phone' | translate }}</span>
          <input class="input" type="text" formControlName="phone" />
        </label>

        <label class="label">
          <span>{{ 'partner.form.address' | translate }}</span>
          <input class="input" type="text" formControlName="address" />
        </label>

        <label class="label">
          <span>{{ 'auth.fields.password' | translate }}</span>
          <input class="input" type="password" formControlName="password" />
        </label>

        <div class="form-actions">
          <button class="btn success" type="submit" [disabled]="form.invalid || loading()">
            {{ isEdit() ? ('common.save' | translate) : ('common.create' | translate) }}
          </button>
          <button class="btn ghost" type="button" (click)="new()" [disabled]="loading()">
            {{ 'partner.buttons.clear' | translate }}
          </button>
        </div>
      </form>
    </div>
  </div>

</section>