<section class="stack-lg">

  <!-- LISTADO / PANEL PRINCIPAL -->
  <div class="glass-dark card stack-md">
    <!-- Toolbar -->
    <header class="header">
      <h2 class="title">Productos</h2>
      <div class="right">
        <button class="btn" type="button" (click)="toggleNuevo()" [attr.aria-expanded]="nuevoAbierto">
          {{ nuevoAbierto ? 'Cerrar' : '+ Nuevo producto' }}
        </button>
      </div>
    </header>

    <!-- Mensajes -->
    <div class="error" *ngIf="error() as err">
      <strong>Error:</strong> {{ err }}
    </div>
    <div class="muted" *ngIf="loading()">Cargando productos...</div>

    <!-- Filtros -->
    <section class="filters">
      <label class="label">
        <span class="label-text">Buscar</span>
        <input class="input" type="text" placeholder="Nombre o categoría" [value]="fTexto()"
          (input)="fTexto.set($any($event.target).value)" />
      </label>

      <label class="label">
        <span class="label-text">Stock</span>
        <select class="input" [value]="fStock()" (change)="fStock.set($any($event.target).value)">
          <option value="todos">Todos</option>
          <option value="con">Con stock</option>
          <option value="sin">Sin stock</option>
        </select>
      </label>
    </section>

    <!-- TABLA: Listado principal -->
    <section class="subsection">
      <h3 class="sub-title">Listado</h3>

      <div class="table-wrap" *ngIf="listaFiltrada().length; else emptyState">
        <table class="table">
          <thead>
            <tr>
              <th style="width:80px;">ID</th>
              <th>Descripción</th>
              <th style="width:140px;">Precio</th>
              <th style="width:120px;">Stock</th>
              <th style="width:120px;">Ilegal</th>
              <th style="width:200px;" class="right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of listaFiltrada()">
              <td>#{{ p.id }}</td>
              <td>{{ p.descripcion }}</td>
              <td>{{ p.precio | currency:'ARS':'symbol':'1.0-2' }}</td>
              <td>
                <span class="badge" [class.badge-warn]="p.stock === 0">{{ p.stock }}</span>
              </td>
              <td>
                <span class="badge" [class.badge-danger]="p.esIlegal" [class.badge-ok]="!p.esIlegal">
                  {{ p.esIlegal ? 'Sí' : 'No' }}
                </span>
              </td>
              <td class="right">
                <button class="btn ghost" type="button" (click)="editar(p)">Editar</button>
                <button class="btn danger" type="button" (click)="eliminar(p.id)"
                  [disabled]="loading()">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty state -->
      <ng-template #emptyState>
        <div class="empty">
          <h3>No hay productos</h3>
          <p>Probá ajustar los filtros o creá un producto nuevo.</p>
          <button class="btn" type="button" (click)="toggleNuevo()">+ Crear producto</button>
        </div>
      </ng-template>
    </section>

    <!-- (OPCIONAL) Otra tabla dentro del mismo panel -->
    <!--
    <section class="subsection">
      <h3 class="sub-title">Top vendidos</h3>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th class="right">Unidades</th>
              <th class="right">Ingresos</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of topVendidos()">
              <td>{{ t.descripcion }}</td>
              <td class="right">{{ t.unidades }}</td>
              <td class="right">{{ t.ingresos | currency:'ARS' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    -->
  </div>

  <!-- FORMULARIO (PLEGABLE) -->
  <div class="collapsible" [class.open]="nuevoAbierto">
    <div class="collapsible__content glass-dark card">
      <div class="header">
        <h2 class="title">
          {{ editId() == null ? 'Crear producto' : ('Editar producto #' + editId()) }}
        </h2>
      </div>

      <form [formGroup]="form" (ngSubmit)="guardar()" class="form-grid">
        <label class="label col-2">
          <span>Descripción</span>
          <input class="input" formControlName="descripcion" placeholder="Descripción del producto" />
          <small class="hint" *ngIf="form.controls.descripcion.invalid && form.controls.descripcion.touched">
            Campo requerido.
          </small>
        </label>

        <label class="label">
          <span>Precio</span>
          <input class="input" type="number" min="0" formControlName="precio" />
          <small class="hint" *ngIf="form.controls.precio.invalid && form.controls.precio.touched">
            Ingresá un precio válido.
          </small>
        </label>

        <label class="label">
          <span>Stock</span>
          <input class="input" type="number" min="0" formControlName="stock" />
          <small class="hint" *ngIf="form.controls.stock.invalid && form.controls.stock.touched">
            Ingresá un stock válido.
          </small>
        </label>

        <label class="label switch">
          <input type="checkbox" formControlName="esIlegal" />
          <span>¿Es ilegal?</span>
        </label>

        <div class="form-actions">
          <button class="btn success" type="submit" [disabled]="form.invalid || loading()">
            {{ editId() == null ? 'Crear' : 'Guardar' }}
          </button>
          <button class="btn ghost" type="button" (click)="nuevo()" [disabled]="loading()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

</section>