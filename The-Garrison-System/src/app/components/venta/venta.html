<section class="stack-lg">

  <!-- LISTADO -->
  <div class="glass-dark card stack-md">
    <div class="header">
      <h2>Ventas</h2>
      <div class="right">
        <button class="btn" type="button" (click)="toggleNuevo()" [attr.aria-expanded]="nuevoAbierto">
          {{ nuevoAbierto ? 'Cerrar' : 'Nueva' }}
        </button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <label class="label">
        <span>Buscar</span>
        <input class="input" placeholder="id, descripción de producto o cliente" [(ngModel)]="fTexto" />
      </label>
      <label class="label">
        <span>DNI cliente</span>
        <input class="input" placeholder="" maxlength="8" [(ngModel)]="fClienteDni" />
      </label>
    </div>

    <!-- Tabla -->
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Productos</th>
            <th>Cantidad</th>
            <th class="left">Total</th>
          </tr>
        </thead>
        <tbody>
          @for (v of ventasFiltradas(); track v.id) {
          <tr>
            <td>{{ v.id }}</td>
            <td>{{ v.fecha | date:'short' }}</td>
            <td>
              @if (getCliente(v); as cli) {
              {{ cli.dni }} - {{ cli.nombre || 'Cliente' }}
              } @else {
              —
              }
            </td>

            <!-- Productos / descripción de ítems -->
            <td>
              @if (tieneDetalles(v)) {
              {{ getDetalles(v).length }} ítem(s)
              <div class="muted">
                @for (d of getDetalles(v); track d.productoId; let last = $last) {
                {{ descDetalle(d) }}@if (!last) {, }
                }
              </div>
              } @else {
              {{ getProductoDesc(v) }}
              }
            </td>

            <!-- Cantidad total -->
            <td>
              @if (tieneDetalles(v)) { {{ sumarCantidades(v) }} }
              @else { {{ (typeof v.cantidad === 'number') ? v.cantidad : 0 }} }
            </td>

            <!-- Total -->
            <td class="right">{{ calcularTotal(v) | currency:'ARS' }}</td>
          </tr>
          }
          @if (ventasFiltradas().length === 0) {
          <tr>
            <td colspan="6" class="center muted">Sin ventas</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- FORM CREAR (PLEGABLE, MISMO ESTILO QUE LISTA) -->
  <div class="collapsible" [class.open]="nuevoAbierto">
    <div class="collapsible__content glass-dark card">
      <div class="header">
        <h2>Nueva venta</h2>
      </div>

      <form [formGroup]="form" (ngSubmit)="guardar()" class="form-grid">
        @if (error()) {
        <div class="error">{{ error() }}</div>
        }

        <!-- Cliente -->
        <label class="label">
          <span>Cliente</span>
          <input class="input" placeholder="filtrar (dni o nombre)" maxlength="8" [(ngModel)]="filtroCliente"
            [ngModelOptions]="{standalone: true}" name="fltCliente" />
          <select class="input" formControlName="clienteDni">
            <option [ngValue]="null" disabled>Elegí un cliente</option>
            @for (c of clientesFiltrados(); track c.dni) {
            <option [ngValue]="c.dni">{{ c.dni }} - {{ c.nombre }}</option>
            }
          </select>
          <small class="muted">¿No figura? Crealo desde <strong>Clientes</strong>.</small>
        </label>

        <div class="subheader">Productos</div>

        @for (l of lineas(); track $index; let i = $index) {
        <div class="linea">
          <div class="linea__row">
            <div class="linea__cell">
              <label class="label">
                <span>Buscar producto</span>
                <input class="input" placeholder="id o descripción" [(ngModel)]="l.filtro"
                  [ngModelOptions]="{standalone: true}" [name]="'fltProd' + i" />
              </label>
            </div>

            <div class="linea__cell">
              <label class="label">
                <span>Producto</span>
                <select class="input" [(ngModel)]="l.productoId" [ngModelOptions]="{standalone: true}"
                  [name]="'prod' + i">
                  <option [ngValue]="null" disabled>Elegí un producto</option>
                  @for (p of productosFiltradosPor(l.filtro || ''); track p.id) {
                  <option [ngValue]="p.id">
                    {{ p.id }} - {{ p.descripcion }} ({{ p.stock }} u.) - {{ p.precio | currency:'ARS' }}
                  </option>
                  }
                </select>
              </label>
            </div>

            <div class="linea__cell sm">
              <label class="label">
                <span>Cantidad</span>
                <input class="input" type="number" min="1" step="1" [attr.max]="getStock(l.productoId) || null"
                  title="Stock disponible: {{ getStock(l.productoId) }}" [(ngModel)]="l.cantidad"
                  (blur)="clampCantidad(i)" [ngModelOptions]="{standalone: true}" [name]="'cant' + i" />
              </label>
            </div>

            <div class="linea__cell actions">
              <button class="btn danger" type="button" (click)="quitarLinea(i)">Quitar</button>
            </div>
          </div>
        </div>
        }

        <div class="right" style="grid-column: 1 / -1; margin-top: .5rem;">
          <button class="btn" type="button" (click)="agregarLinea()">+ Agregar producto</button>
        </div>

        <div class="right" style="grid-column: 1 / -1;">
          <button class="btn success" type="submit" [disabled]="loading()">Crear</button>
          <button class="btn ghost" type="button" (click)="nuevo()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</section>