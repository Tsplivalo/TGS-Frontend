<section class="stack-lg">

  <div class="glass-dark card stack-md">
    <!-- HEADER -->
    <header class="header">
      <h2 class="title">{{ 'roleRequest.title' | translate }}</h2>
      <div class="right">
        <button class="btn" type="button" (click)="toggleNew()" [attr.aria-expanded]="isNewOpen()">
          {{ isNewOpen() ? ('roleRequest.buttons.close' | translate) : ('roleRequest.buttons.new' | translate) }}
        </button>
      </div>
    </header>

    <!-- MENSAJES -->
    <div class="error" *ngIf="error() as err">
      <strong>{{ 'common.error' | translate }}</strong>: {{ err }}
    </div>
    <div class="muted" *ngIf="loading()">{{ 'admin.messages.loading' | translate }}</div>

    <!-- MIS SOLICITUDES -->
    <section class="subsection">
      <h3 class="sub-title">{{ 'roleRequest.my.title' | translate }}</h3>

      <div *ngIf="my().length; else emptyMine">
        <table class="table">
          <thead>
            <tr>
              <th style="width:160px;">{{ 'roleRequest.table.role' | translate }}</th>
              <th>{{ 'roleRequest.table.reason' | translate }}</th>
              <th style="width:160px;">{{ 'roleRequest.table.status' | translate }}</th>
              <th style="width:200px;">{{ 'roleRequest.table.createdAt' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of my()">
              <td class="mono">{{ ('roles.' + r.requestedRole) | translate }}</td>
              <td class="truncate">{{ r.reason || '—' }}</td>
              <td>
                <span class="badge {{ r.status }}">{{ ('status.' + r.status) | translate }}</span>
              </td>
              <td>{{ r.createdAt | date:'yyyy-MM-dd HH:mm' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #emptyMine>
        <div class="empty empty-state">
          <h3>{{ 'roleRequest.my.emptyTitle' | translate }}</h3>
          <p class="muted">{{ 'roleRequest.my.emptyHint' | translate }}</p>
        </div>
      </ng-template>
    </section>

    <!-- PENDIENTES (ADMIN) -->
    <section class="subsection" *ngIf="isAdmin()">
      <h3 class="sub-title">{{ 'roleRequest.pending.title' | translate }}</h3>

      <div class="table-wrap" *ngIf="pending().length; else emptyPending">
        <table class="table">
          <thead>
            <tr>
              <th>{{ 'roleRequest.table.user' | translate }}</th>
              <th style="width:160px;">{{ 'roleRequest.table.role' | translate }}</th>
              <th>{{ 'roleRequest.table.reason' | translate }}</th>
              <th style="width:160px;">{{ 'roleRequest.table.status' | translate }}</th>
              <th class="right" style="width:160px;">{{ 'common.edit' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of pending()">
              <td class="truncate">{{ r.user.email }}</td>
              <td class="mono">{{ ('roles.' + r.requestedRole) | translate }}</td>
              <td class="truncate">{{ r.reason || '—' }}</td>
              <td><span class="badge {{ r.status }}">{{ ('status.' + r.status) | translate }}</span></td>
              <td class="right">
                <button class="btn success btn--icon" type="button" (click)="approve(r)"
                  [title]="'roleRequest.buttons.approve' | translate">
                  ✅ <span class="sr-only">{{ 'roleRequest.buttons.approve' | translate }}</span>
                </button>
                <button class="btn danger btn--icon" type="button" (click)="reject(r)"
                  [title]="'roleRequest.buttons.reject' | translate">
                  ⛔ <span class="sr-only">{{ 'roleRequest.buttons.reject' | translate }}</span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #emptyPending>
        <div class="empty empty-state">
          <h3>{{ 'roleRequest.pending.emptyTitle' | translate }}</h3>
          <p class="muted">{{ 'roleRequest.pending.emptyHint' | translate }}</p>
        </div>
      </ng-template>
    </section>
  </div>

  <!-- PANEL CREAR (COLAPSABLE) -->
  <div class="collapsible" [class.open]="isNewOpen()">
    <div class="collapsible__content glass-dark card">
      <div class="header">
        <h2 class="title">{{ 'roleRequest.create.title' | translate }}</h2>
      </div>

      <form [formGroup]="form" class="form-grid" (ngSubmit)="submit()">
        <label class="label">
          <span>{{ 'roleRequest.form.requestedRole' | translate }}</span>
          <select class="input" formControlName="requestedRole">
            <option [value]="'PARTNER'">{{ 'roles.PARTNER' | translate }}</option>
            <option [value]="'DISTRIBUTOR'">{{ 'roles.DISTRIBUTOR' | translate }}</option>
          </select>
        </label>

        <label class="label">
          <span>{{ 'roleRequest.form.roleToRemove' | translate }}</span>
          <select class="input" formControlName="roleToRemove">
            <option [ngValue]="null">—</option>
            <option [value]="'CLIENT'">{{ 'roles.CLIENT' | translate }}</option>
            <option [value]="'DISTRIBUTOR'">{{ 'roles.DISTRIBUTOR' | translate }}</option>
            <option [value]="'PARTNER'">{{ 'roles.PARTNER' | translate }}</option>
          </select>
        </label>

        <label class="label col-2">
          <span>{{ 'roleRequest.form.reason' | translate }}</span>
          <textarea class="input" rows="2" formControlName="reason"></textarea>
        </label>

        <div class="form-actions">
          <button class="btn success" type="submit" [disabled]="form.invalid || loading()">
            {{ 'roleRequest.buttons.send' | translate }}
          </button>
          <button class="btn ghost" type="button" (click)="toggleNew()">
            {{ 'roleRequest.buttons.cancel' | translate }}
          </button>
        </div>
      </form>
    </div>
  </div>

</section>