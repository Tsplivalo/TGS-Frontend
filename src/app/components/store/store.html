<section class="store">
  <header class="store__header">
    <h2 class="store__title">{{ 'store.title' | translate }}</h2>

    <div class="store__filters">
      <label class="field">
        <span class="label">{{ 'store.search' | translate }}</span>
        <div class="search-wrapper">
          <input class="input" type="text" [placeholder]="'store.search' | translate" [value]="searchInput()"
            (input)="searchInput.set($any($event.target).value)" (keydown)="onSearchKeydown($event)" />

          <div class="search-actions">
            <button class="btn btn--search" type="button" (click)="onSearch()" [disabled]="!searchInput()">
              üîç Buscar
            </button>

            <button *ngIf="searchQuery()" class="btn btn--clear" type="button" (click)="onClearSearch()">
              ‚úï
            </button>
          </div>
        </div>
      </label>
    </div>
  </header>

  <div class="search-indicator" *ngIf="searchQuery()">
    <span class="search-indicator__text">
      üîç Buscando: <strong>{{ searchQuery() }}</strong>
    </span>
    <span class="search-indicator__count">
      {{ list().length }} {{ list().length === 1 ? 'resultado' : 'resultados' }}
    </span>
  </div>

  <div class="error" *ngIf="error() as e">{{ e }}</div>
  <div class="muted" *ngIf="loading()">{{ 'account.loading' | translate }}</div>

  <div class="store__grid" *ngIf="!loading() && list().length > 0">
    <article class="store-card" *ngFor="let p of list()" [class.flash]="flashId() === p.id"
      [class.unavailable]="!isProductAvailable(p.id)">
      <div class="store-card__media">
        <ng-container *ngIf="p.imageUrl as url; else noimg">
          <img [src]="url" [alt]="p.description || ('Producto ' + p.id)" loading="lazy" />
        </ng-container>
        <ng-template #noimg>
          <div class="noimg">{{ 'store.noImage' | translate }}</div>
        </ng-template>

        <!-- Badge de "No disponible" -->
        <div class="unavailable-badge" *ngIf="!isProductAvailable(p.id)">
          <span>‚ö†Ô∏è No disponible</span>
        </div>
      </div>

      <div class="store-card__body">
        <h4 class="store-card__title">{{ p.description || ('Producto ' + p.id) }}</h4>
      </div>

      <div class="store-card__footer">
        <div class="store-card__price">
          <span class="currency">$</span>
          <span class="amount">{{ p.price | number: '1.2-2' }}</span>
        </div>

        <button class="btn btn--accent" type="button" (click)="onAddClick($event, p)"
          [disabled]="!isProductAvailable(p.id)"
          [title]="!isProductAvailable(p.id) ? 'Producto no disponible - Ning√∫n distribuidor lo tiene' : ''">
          {{ !isProductAvailable(p.id) ? 'üö´ No disponible' : ('store.add' | translate) }}
        </button>
      </div>
    </article>
  </div>

  <div class="store__empty" *ngIf="!loading() && list().length === 0">
    <h3>{{ searchQuery() ? 'Sin resultados' : ('store.noProducts.title' | translate) }}</h3>
    <p>{{ searchQuery() ? 'No se encontraron productos con ese t√©rmino de b√∫squeda.' : ('store.noProducts.desc' |
      translate) }}</p>
    <button *ngIf="searchQuery()" class="btn btn--accent" type="button" (click)="onClearSearch()">
      Limpiar b√∫squeda
    </button>
  </div>

  <!-- FAB -->
  <button id="cartAnchor" class="cart-fab" type="button" (click)="toggleCartDrawer()" [class.bump]="bumpCart()"
    [attr.aria-label]="'store.cart.open' | translate">
    <span class="cart-fab__icon">üõí</span>
    <span class="cart-fab__count">{{ cart.count() }}</span>
  </button>

  <!-- Drawer -->
  <div class="cart-drawer" [class.open]="showCart()">
    <header class="cart-drawer__header">
      <h4>{{ 'store.cart.items' | translate:{ count: cart.count() } }}</h4>
      <button class="btn btn--ghost" type="button" (click)="toggleCartDrawer()">
        {{ 'store.cart.close' | translate }}
      </button>
    </header>

    <ul class="cart-drawer__list">
      <li class="cart-drawer__item" *ngFor="let it of cart.items()">
        <img *ngIf="it.imageUrl as url" [src]="url" alt="" class="cart-drawer__thumb" loading="lazy" />
        <div class="cart-drawer__meta">
          <div class="cart-drawer__title">{{ it.description }}</div>
          <div class="cart-drawer__price">$ {{ it.price | number:'1.2-2' }}</div>
        </div>
        <div class="cart-drawer__qty">
          <button type="button" (click)="dec(it.id)">-</button>
          <span>{{ it.qty }}</span>
          <button type="button" (click)="inc(it.id)">+</button>
        </div>
        <button type="button" class="cart-drawer__remove" (click)="remove(it.id)">‚úï</button>
      </li>
    </ul>

    <footer class="cart-drawer__footer">
      <!-- Alertas de compra -->
      <div class="cart-purchase-alert" *ngIf="!canPurchase()">
        <div class="alert alert--warning">
          <span class="alert__icon">‚ö†Ô∏è</span>
          <div class="alert__content">
            <strong>No puedes comprar a√∫n</strong>
            <p *ngIf="!isVerified()">
              Debes verificar tu cuenta con un administrador.
              <a routerLink="/inbox/verification" (click)="toggleCartDrawer()">Solicitar verificaci√≥n</a>
            </p>
            <p *ngIf="isVerified() && profileCompleteness() < 100">
              Completa tu perfil al 100% para comprar.
              <a routerLink="/mi-cuenta" (click)="toggleCartDrawer()">Completar perfil</a>
            </p>
          </div>
        </div>
      </div>

      <!-- ‚úÖ Informaci√≥n del distribuidor seleccionado (√öNICO distribuidor) -->
      <div class="distributor-info" *ngIf="!hasMultipleDistributors() && selectedDistributor() as dist">
        <ng-container *ngIf="cart.count() > 0">
          <div class="info-badge">
            <span class="icon">üè¢</span>
            <div class="info-content">
              <strong>{{ dist.name }}</strong>
              <small *ngIf="dist.zone">
                {{ dist.zone.name }}
                <span *ngIf="dist.zone.isHeadquarters" class="hq-badge">‚≠ê Sede Central</span>
              </small>
              <small *ngIf="!dist.zone" class="muted">Sin zona asignada</small>
            </div>
          </div>
          <div class="distributor-hint">
            <span class="hint-icon">üìç</span>
            <span class="hint-text">Tu pedido se procesar√° en esta ubicaci√≥n</span>
          </div>
        </ng-container>
      </div>

      <!-- üìç MEJORADO: Informaci√≥n de M√öLTIPLES distribuidores -->
      <div class="multiple-distributors-info" *ngIf="hasMultipleDistributors() && cart.count() > 0">
        <div class="alert-header">
          <span class="alert-icon">üì¶</span>
          <div class="alert-content">
            <strong>Pedido dividido en {{ selectedDistributors().length }} ubicaciones</strong>
            <p>Crearemos {{ selectedDistributors().length }} √≥rdenes de compra, una por cada ubicaci√≥n.</p>
          </div>
        </div>

        <div class="distributors-grid">
          <div class="distributor-card" *ngFor="let dist of selectedDistributors(); let i = index">
            <div class="card-header">
              <div class="card-number">{{ i + 1 }}</div>
              <div class="card-title">
                <strong>{{ dist.name }}</strong>
                <span class="zone-badge" *ngIf="dist.zone">
                  <span class="zone-icon">üìç</span>
                  {{ dist.zone.name }}
                  <span class="hq-star" *ngIf="dist.zone.isHeadquarters">‚≠ê</span>
                </span>
              </div>
            </div>

            <div class="card-products">
              <div class="products-header">
                <span class="products-count">{{ productsByDistributor().get(dist.dni)?.length || 0 }} producto(s)</span>
              </div>
              <ul class="compact-products-list">
                <li *ngFor="let item of productsByDistributor().get(dist.dni)">
                  <span class="product-info">
                    <span class="product-name">{{ item.description }}</span>
                    <span class="product-detail">x{{ item.qty }} ¬∑ ${{ (item.price * item.qty) | number:'1.2-2'
                      }}</span>
                  </span>
                  <button type="button" class="btn-remove-product" (click)="remove(item.id)" title="Quitar">
                    <span class="remove-icon">√ó</span>
                  </button>
                </li>
              </ul>

              <div class="card-subtotal">
                <span>Subtotal</span>
                <strong>${{ getDistributorSubtotal(dist.dni) | number:'1.2-2' }}</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="multiple-purchase-note">
          <span class="note-icon">‚ÑπÔ∏è</span>
          <span class="note-text">
            Se crear√°n {{ selectedDistributors().length }} compras separadas. Recibir√°s una confirmaci√≥n por cada una.
          </span>
        </div>
      </div>

      <!-- ‚ö†Ô∏è Mensaje cuando NO hay distribuidor disponible -->
      <div class="distributor-warning" *ngIf="selectedDistributors().length === 0 && cart.count() > 0">
        <div class="alert alert--error">
          <span class="alert__icon">‚ö†Ô∏è</span>
          <div class="alert__content">
            <strong>Productos no disponibles</strong>
            <p>Ning√∫n distribuidor tiene los productos de tu carrito. Por favor, elimina algunos items o contacta al
              administrador.</p>
          </div>
        </div>
      </div>

      <div class="cart-drawer__total">
        <span>{{ 'store.cart.total' | translate }}</span>
        <strong>$ {{ cart.total() | number:'1.2-2' }}</strong>
      </div>

      <button class="btn btn--accent" type="button"
        [disabled]="!canPurchase() || cart.count() === 0 || processing() || selectedDistributors().length === 0"
        [class.btn--disabled]="!canPurchase() || cart.count() === 0 || selectedDistributors().length === 0"
        (click)="goToCheckout()">
        <span class="icon" *ngIf="!processing()">üõí</span>
        <span *ngIf="processing()">‚è≥</span>
        <span *ngIf="!processing()">
          {{ hasMultipleDistributors()
          ? 'Crear ' + selectedDistributors().length + ' Compras'
          : 'Realizar Compra'
          }}
        </span>
        <span *ngIf="processing()">
          {{ hasMultipleDistributors()
          ? 'Creando compras...'
          : 'Procesando...'
          }}
        </span>
      </button>
    </footer>
  </div>

  <div class="cart-backdrop" *ngIf="showCart()" (click)="toggleCartDrawer()"></div>

  <!-- Modal de √©xito -->
  <app-purchase-success-modal *ngIf="showSuccessModal() && purchaseData()" [data]="purchaseData()!"
    (close)="onCloseSuccessModal()">
  </app-purchase-success-modal>
</section>





