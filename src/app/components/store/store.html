<section class="store">
  <header class="store__header">
    <h2 class="store__title">{{ 'store.title' | translate }}</h2>

    <div class="store__filters">
      <label class="field">
        <span class="label">{{ 'store.search' | translate }}</span>
        <div class="search-wrapper">
          <input class="input" type="text" [placeholder]="'store.search' | translate" [value]="searchInput()"
            (input)="searchInput.set($any($event.target).value)" (keydown)="onSearchKeydown($event)" />

          <!-- Botones de b√∫squeda -->
          <div class="search-actions">
            <button class="btn btn--search" type="button" (click)="onSearch()" [disabled]="!searchInput()">
              üîç Buscar
            </button>

            <button *ngIf="searchQuery()" class="btn btn--clear" type="button" (click)="onClearSearch()">
              ‚úï
            </button>
          </div>
        </div>
      </label>
    </div>
  </header>

  <!-- Indicador de b√∫squeda activa -->
  <div class="search-indicator" *ngIf="searchQuery()">
    <span class="search-indicator__text">
      üîç Buscando: <strong>{{ searchQuery() }}</strong>
    </span>
    <span class="search-indicator__count">
      {{ list().length }} {{ list().length === 1 ? 'resultado' : 'resultados' }}
    </span>
  </div>

  <div class="error" *ngIf="error() as e">{{ e }}</div>
  <div class="muted" *ngIf="loading()">{{ 'account.loading' | translate }}</div>

  <div class="store__grid" *ngIf="!loading() && list().length > 0">
    <article class="store-card" *ngFor="let p of list()" [class.flash]="flashId() === p.id">
      <div class="store-card__media">
        <ng-container *ngIf="p.imageUrl as url; else noimg">
          <img [src]="url" [alt]="p.description || ('Producto ' + p.id)" loading="lazy" />
        </ng-container>
        <ng-template #noimg>
          <div class="noimg">{{ 'store.noImage' | translate }}</div>
        </ng-template>
      </div>

      <div class="store-card__body">
        <h4 class="store-card__title">{{ p.description || ('Producto ' + p.id) }}</h4>
      </div>

      <div class="store-card__footer">
        <div class="store-card__price">
          <span class="currency">$</span>
          <span class="amount">{{ p.price | number: '1.2-2' }}</span>
        </div>

        <button class="btn btn--accent" type="button" (click)="onAddClick($event, p)">
          {{ 'store.add' | translate }}
        </button>
      </div>
    </article>
  </div>

  <div class="store__empty" *ngIf="!loading() && list().length === 0">
    <h3>{{ searchQuery() ? 'Sin resultados' : ('store.noProducts.title' | translate) }}</h3>
    <p>{{ searchQuery() ? 'No se encontraron productos con ese t√©rmino de b√∫squeda.' : ('store.noProducts.desc' |
      translate) }}</p>
    <button *ngIf="searchQuery()" class="btn btn--accent" type="button" (click)="onClearSearch()">
      Limpiar b√∫squeda
    </button>
  </div>

  <!-- FAB -->
  <button id="cartAnchor" class="cart-fab" type="button" (click)="toggleCartDrawer()" [class.bump]="bumpCart()"
    [attr.aria-label]="'store.cart.open' | translate">
    <span class="cart-fab__icon">üõí</span>
    <span class="cart-fab__count">{{ cart.count() }}</span>
  </button>

  <!-- Drawer -->
  <div class="cart-drawer" [class.open]="showCart()">
    <header class="cart-drawer__header">
      <h4>{{ 'store.cart.items' | translate:{ count: cart.count() } }}</h4>
      <button class="btn btn--ghost" type="button" (click)="toggleCartDrawer()">
        {{ 'store.cart.close' | translate }}
      </button>
    </header>

    <ul class="cart-drawer__list">
      <li class="cart-drawer__item" *ngFor="let it of cart.items()">
        <img *ngIf="it.imageUrl as url" [src]="url" alt="" class="cart-drawer__thumb" loading="lazy" />
        <div class="cart-drawer__meta">
          <div class="cart-drawer__title">{{ it.description }}</div>
          <div class="cart-drawer__price">$ {{ it.price | number:'1.2-2' }}</div>
        </div>
        <div class="cart-drawer__qty">
          <button type="button" (click)="dec(it.id)">-</button>
          <span>{{ it.qty }}</span>
          <button type="button" (click)="inc(it.id)">+</button>
        </div>
        <button type="button" class="cart-drawer__remove" (click)="remove(it.id)">‚úï</button>
      </li>
    </ul>

    <footer class="cart-drawer__footer">
      <div class="cart-purchase-alert" *ngIf="!canPurchase()">
        <div class="alert alert--warning">
          <span class="alert__icon">‚ö†Ô∏è</span>
          <div class="alert__content">
            <strong>No puedes comprar a√∫n</strong>
            <p *ngIf="!isVerified()">
              Debes verificar tu cuenta con un administrador para poder realizar compras.
              <a routerLink="/inbox/verification" (click)="toggleCartDrawer()">Solicitar verificaci√≥n</a>
            </p>
            <p *ngIf="isVerified() && profileCompleteness() < 100">
              Completa tu perfil al 100% para poder comprar.
              <a routerLink="/mi-cuenta" (click)="toggleCartDrawer()">Completar perfil</a>
            </p>
          </div>
        </div>
      </div>

      <div class="cart-drawer__total">
        <span>{{ 'store.cart.total' | translate }}</span>
        <strong>$ {{ cart.total() | number:'1.2-2' }}</strong>
      </div>

      <button class="btn btn--accent" type="button" [disabled]="!canPurchase() || cart.count() === 0 || processing()"
        [class.btn--disabled]="!canPurchase() || cart.count() === 0" (click)="goToCheckout()">
        <span class="icon" *ngIf="!processing()">üõí</span>
        <span *ngIf="processing()">‚è≥</span>
        {{ processing() ? 'Procesando...' : 'Realizar Compra' }}
      </button>
    </footer>
  </div>

  <div class="cart-backdrop" *ngIf="showCart()" (click)="toggleCartDrawer()"></div>

  <app-purchase-success-modal *ngIf="showSuccessModal() && purchaseData()" [data]="purchaseData()!"
    (close)="onCloseSuccessModal()">
  </app-purchase-success-modal>
</section>