<section class="stack-lg">
  <!-- HEADER PRINCIPAL CON BOT√ìN -->
  <div class="glass-dark card">
    <header class="header">
      <h2 class="title">{{ 'monthlyReview.title' | translate : {} : 'Revisiones Mensuales' }}</h2>
      <div class="right">
        <button class="btn" type="button" (click)="toggleNew()" [attr.aria-expanded]="isNewOpen()">
          {{ isNewOpen()
          ? ('Cerrar' | translate : {} : 'Cerrar')
          : ('Nueva Revisi√≥n' | translate : {} : 'Nueva Revisi√≥n') }}
        </button>
      </div>
    </header>
  </div>

  <!-- ‚úÖ GRID DE 2 COLUMNAS: IZQUIERDA (STATS) | DERECHA (FILTROS + TABLA) -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-6); align-items: start;">

    <!-- ========== COLUMNA IZQUIERDA: ESTAD√çSTICAS Y GR√ÅFICOS ========== -->
    <div class="stack-md">
      <div class="glass-dark card stack-md monthly-shell">

        <!-- ESTAD√çSTICAS R√ÅPIDAS -->
        <div *ngIf="!loading() && items().length > 0"
          style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--sp-3); padding: var(--sp-3); background: rgba(195, 164, 98, 0.08); border-radius: 8px; border: 1px solid rgba(195, 164, 98, 0.2);">
          <div style="text-align: center;">
            <div class="muted" style="font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">{{
              'monthlyReview.stats.total' | translate }}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-strong);">{{ totalReviews() }}</div>
          </div>
          <div style="text-align: center;">
            <div class="muted" style="font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">{{
              'monthlyReview.stats.pending' | translate }}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">{{ reviewsByStatus()['PENDING'] }}</div>
          </div>
          <div style="text-align: center;">
            <div class="muted" style="font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">{{
              'monthlyReview.stats.inReview' | translate }}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">{{ reviewsByStatus()['IN_REVIEW'] }}</div>
          </div>
          <div style="text-align: center;">
            <div class="muted" style="font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">{{
              'monthlyReview.stats.completed' | translate }}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;">{{ reviewsByStatus()['COMPLETED'] }}</div>
          </div>
          <div style="text-align: center;">
            <div class="muted" style="font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">{{
              'monthlyReview.stats.approved' | translate }}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #4a8d72;">{{ reviewsByStatus()['APPROVED'] }}</div>
          </div>
          <div style="text-align: center;">
            <div class="muted" style="font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">{{
              'monthlyReview.stats.rejected' | translate }}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #a94545;">{{ reviewsByStatus()['REJECTED'] }}</div>
          </div>
        </div>

        <!-- GR√ÅFICOS -->
        <section *ngIf="showCharts()">
          <!-- Gr√°fico 1: Distribuci√≥n por Estado -->
          <div
            style="padding: var(--sp-4); background: rgba(0,0,0,0.2); border-radius: var(--radius); margin-bottom: var(--sp-4);">
            <h4 style="margin: 0 0 var(--sp-3); font-size: 0.95rem; color: var(--text);">
              üìå {{ 'monthlyReview.charts.statusDistribution' | translate : {} : 'Distribuci√≥n por Estado' }}
            </h4>
            <app-chart *ngIf="statusChartData()" type="doughnut" [data]="statusChartData()!" height="260px">
            </app-chart>
          </div>

          <!-- Gr√°fico 2: Tendencia de Revisiones -->
          <div
            style="padding: var(--sp-4); background: rgba(0,0,0,0.2); border-radius: var(--radius); margin-bottom: var(--sp-4);">
            <h4 style="margin: 0 0 var(--sp-3); font-size: 0.95rem; color: var(--text);">
              üìà {{ 'monthlyReview.charts.trend' | translate : {} : 'Tendencia de Revisiones por Mes' }}
            </h4>
            <app-chart *ngIf="reviewsTrendChartData()" type="line" [data]="reviewsTrendChartData()!" height="240px">
            </app-chart>
          </div>

          <!-- Gr√°fico 3: Ventas por Producto -->
          <div style="padding: var(--sp-4); background: rgba(0,0,0,0.2); border-radius: var(--radius);"
            *ngIf="productSalesChartData()">
            <h4 style="margin: 0 0 var(--sp-3); font-size: 0.95rem; color: var(--text);">
              üèÜ {{ 'monthlyReview.charts.topProducts' | translate : {} : 'Top Productos por Ventas' }}
            </h4>
            <app-chart type="bar" [data]="productSalesChartData()!" height="280px">
            </app-chart>
          </div>
        </section>

        <!-- ESTAD√çSTICAS DEL PER√çODO -->
        <section *ngIf="statistics() as stats">
          <h3 style="margin: 0 0 var(--sp-3); font-size: 1.1rem; font-weight: 600; color: var(--text);">
            {{ 'monthlyReview.stats.title' | translate : {} : 'Estad√≠sticas del Per√≠odo' }}
          </h3>

          <div
            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--sp-3); padding: var(--sp-3); background: rgba(195, 164, 98, 0.05); border-radius: 8px; margin-bottom: var(--sp-4);"
            *ngIf="stats.summary">
            <div>
              <div class="muted" style="font-size: 11px; text-transform: uppercase;">{{ 'monthlyReview.stats.period' |
                translate : {} : 'Per√≠odo' }}</div>
              <div style="font-weight: 600; color: var(--text);">{{ stats.period }}</div>
            </div>
            <div>
              <div class="muted" style="font-size: 11px; text-transform: uppercase;">{{ 'monthlyReview.stats.totalSales'
                | translate : {} : 'Total Ventas' }}</div>
              <div style="font-weight: 600; color: var(--text);">{{ stats.summary.totalSales }}</div>
            </div>
            <div>
              <div class="muted" style="font-size: 11px; text-transform: uppercase;">{{
                'monthlyReview.stats.totalAmount' | translate : {} : 'Monto Total' }}</div>
              <div style="font-weight: 600; color: var(--text);">{{ formatCurrency(stats.summary.totalAmount) }}</div>
            </div>
            <div>
              <div class="muted" style="font-size: 11px; text-transform: uppercase;">{{
                'monthlyReview.stats.averageAmount' | translate : {} : 'Promedio' }}</div>
              <div style="font-weight: 600; color: var(--text);">{{ formatCurrency(stats.summary.averageAmount) }}</div>
            </div>
          </div>

          <!-- Tabla de productos -->
          <div *ngIf="stats.groupedData && stats.groupedData.length > 0">
            <h4 style="margin: 0 0 var(--sp-3); font-size: 1rem; font-weight: 600; color: var(--text);">
              {{ 'monthlyReview.stats.byProduct' | translate : {} : 'Por Producto' }}
            </h4>
            <div class="table-wrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>{{ 'monthlyReview.stats.productName' | translate : {} : 'Producto' }}</th>
                    <th class="right">{{ 'monthlyReview.stats.quantity' | translate : {} : 'Cantidad' }}</th>
                    <th class="right">{{ 'monthlyReview.stats.amount' | translate : {} : 'Monto' }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of stats.groupedData">
                    <td>{{ item.productName || item.productId }}</td>
                    <td class="right">{{ item.totalQuantitySold }}</td>
                    <td class="right">{{ formatCurrency(item.totalAmount) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- ========== COLUMNA DERECHA: FILTROS + LISTADO ========== -->
    <div class="stack-md">
      <div class="glass-dark card stack-md">

        <!-- FILTROS -->
        <section>


          <div style="display: grid; gap: var(--sp-3);">
            <label class="label">
              <span class="label-text">{{ 'monthlyReview.filters.year' | translate : {} : 'A√±o' }}</span>
              <input class="input" type="number" [value]="fYearInput()"
                (input)="fYearInput.set(+$any($event.target).value)"
                [attr.aria-label]="'monthlyReview.filters.year' | translate : {} : 'A√±o'" />
            </label>

            <label class="label">
              <span class="label-text">{{ 'monthlyReview.filters.month' | translate : {} : 'Mes (1-12)' }}</span>
              <input class="input" type="number" [value]="fMonthInput()"
                (input)="fMonthInput.set($any($event.target).value ? +$any($event.target).value : null)"
                [placeholder]="'monthlyReview.filters.monthPlaceholder' | translate : {} : 'Todos'"
                [attr.aria-label]="'monthlyReview.filters.month' | translate : {} : 'Mes'" />
            </label>

            <label class="label">
              <span class="label-text">{{ 'monthlyReview.filters.status' | translate : {} : 'Estado' }}</span>
              <select class="input" [value]="fStatusInput() || ''"
                (change)="fStatusInput.set($any($event.target).value || null)">
                <option value="">{{ 'common.all' | translate : {} : 'Todos' }}</option>
                <option value="PENDING">{{ 'status.PENDING' | translate : {} : 'Pendiente' }}</option>
                <option value="IN_REVIEW">{{ 'status.IN_REVIEW' | translate : {} : 'En Revisi√≥n' }}</option>
                <option value="COMPLETED">{{ 'status.COMPLETED' | translate : {} : 'Completado' }}</option>
                <option value="APPROVED">{{ 'status.APPROVED' | translate : {} : 'Aprobado' }}</option>
                <option value="REJECTED">{{ 'status.REJECTED' | translate : {} : 'Rechazado' }}</option>
              </select>
            </label>

            <div style="display: flex; gap: var(--sp-2);">
              <button class="btn btn-primary" type="button" (click)="applyFilters()" style="flex: 1;">
                üîç {{ 'common.search' | translate }}
              </button>
              <button class="btn ghost" type="button" (click)="clearFilters()"
                *ngIf="fMonthApplied() || fStatusApplied()">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </section>

        <!-- MENSAJES -->
        <div class="error" *ngIf="error() as err">
          <strong>{{ 'common.error' | translate : {} : 'Error' }}</strong>: {{ err }}
        </div>
        <div class="muted" *ngIf="loading()">
          {{ 'monthlyReview.loading' | translate : {} : 'Cargando...' }}
        </div>

        <!-- LISTADO DE REVISIONES -->
        <section>
          <h3
            style="margin: 0 0 var(--sp-3); font-size: 1.1rem; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: var(--sp-2);">
            üìã {{ 'monthlyReview.list' | translate : {} : 'Listado de Revisiones' }}
          </h3>

          <div class="table-wrap" *ngIf="filtered().length; else emptyState">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:50px;">ID</th>
                  <th>PER√çODO</th>
                  <th>ESTADO</th>
                  <th>REVISOR</th>
                  <th class="right">MONTO</th>
                  <th class="right">VENTAS</th>
                  <th class="right" style="width:100px;">ACCIONES</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let it of filtered(); trackBy: trackById">
                  <td>#{{ it.id }}</td>
                  <td>{{ it.period || (it.month + '/' + it.year) }}</td>
                  <td>
                    <span class="badge {{ it.status }}">{{ it.status }}</span>
                  </td>
                  <td>{{ it.reviewedBy?.name || '‚Äî' }}</td>
                  <td class="right">{{ formatCurrency(it.totalSalesAmount) }}</td>
                  <td class="right">{{ it.totalSalesCount || 0 }}</td>
                  <td class="right">
                    <button class="btn ghost btn--icon" type="button" (click)="edit(it)" title="Editar">
                      ‚úèÔ∏è
                    </button>
                    <button class="btn danger btn--icon" type="button" (click)="delete(it)" title="Eliminar">
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Empty state -->
          <ng-template #emptyState>
            <div class="empty-state">
              <h3>{{ (fMonthApplied() || fStatusApplied()) ? 'Sin resultados' : 'No hay revisiones' }}</h3>
              <p class="muted">
                {{ (fMonthApplied() || fStatusApplied())
                ? 'Prob√° ajustar los filtros'
                : 'Cre√° una nueva revisi√≥n para comenzar.' }}
              </p>
            </div>
          </ng-template>
        </section>
      </div>
    </div>
  </div>

</section>

<!-- Overlay flotante para crear/editar revisiÔøΩn -->
<div class="monthly-overlay" [class.is-open]="isNewOpen()" [attr.aria-hidden]="!isNewOpen()">
  <button type="button" class="monthly-overlay__backdrop" (click)="cancel()" aria-label="Cerrar"></button>

  <div class="monthly-overlay__panel glass-dark card" role="dialog" aria-modal="true"
    (click)="$event.stopPropagation()">
    <div class="header compact">
      <h2 class="title">
        {{ isEdit()
        ? ('monthlyReview.form.titleEdit' | translate : { id: form.value.id } : ('Editar #' + form.value.id))
        : ('monthlyReview.form.titleCreate' | translate : {} : 'Crear RevisiÔøΩn Mensual') }}
      </h2>
      <button type="button" class="btn-close" (click)="cancel()" aria-label="Cerrar">&times;</button>
    </div>

    <div class="error" *ngIf="error()">{{ error() }}</div>

    <form [formGroup]="form" class="form-grid" (ngSubmit)="save()">
      <!-- DNI del Socio Revisor -->
      <label class="label">
        <span>{{ 'monthlyReview.form.fields.partnerDni' | translate : {} : 'Socio Revisor' }} *</span>
        <select class="input" formControlName="partnerDni">
          <option value="" disabled>ÔøΩ SeleccionÔøΩ un socio ÔøΩ</option>
          <option *ngFor="let p of partners()" [value]="p.dni">
            {{ p.dni }} ÔøΩ {{ p.name }}
          </option>
        </select>
        <small class="muted" *ngIf="!partners().length && !loading()">
          No hay socios disponibles. CreÔøΩ uno primero.
        </small>
        <small class="error" *ngIf="form.controls.partnerDni.invalid && form.controls.partnerDni.touched">
          {{ 'monthlyReview.form.errors.partnerDni' | translate : {} : 'Socio requerido' }}
        </small>
      </label>

      <!-- AÔøΩo -->
      <label class="label">
        <span>{{ 'monthlyReview.form.fields.year' | translate : {} : 'AÔøΩo' }} *</span>
        <input class="input" type="number" formControlName="year"
          [attr.aria-label]="'monthlyReview.form.fields.year' | translate : {} : 'AÔøΩo'" />
      </label>

      <!-- Mes -->
      <label class="label">
        <span>{{ 'monthlyReview.form.fields.month' | translate : {} : 'Mes (1-12)' }} *</span>
        <input class="input" type="number" formControlName="month" min="1" max="12"
          [attr.aria-label]="'monthlyReview.form.fields.month' | translate : {} : 'Mes'" />
      </label>

      <!-- Fecha de RevisiÔøΩn -->
      <label class="label">
        <span>{{ 'monthlyReview.form.fields.reviewDate' | translate : {} : 'Fecha de RevisiÔøΩn' }}</span>
        <input class="input" type="date" formControlName="reviewDate"
          [attr.aria-label]="'monthlyReview.form.fields.reviewDate' | translate : {} : 'Fecha de RevisiÔøΩn'" />
      </label>

      <!-- Estado -->
      <label class="label">
        <span>{{ 'monthlyReview.form.fields.status' | translate : {} : 'Estado' }}</span>
        <select class="input" formControlName="status">
          <option value="PENDING">{{ 'status.PENDING' | translate : {} : 'Pendiente' }}</option>
          <option value="IN_REVIEW">{{ 'status.IN_REVIEW' | translate : {} : 'En RevisiÔøΩn' }}</option>
          <option value="COMPLETED">{{ 'status.COMPLETED' | translate : {} : 'Completado' }}</option>
          <option value="APPROVED">{{ 'status.APPROVED' | translate : {} : 'Aprobado' }}</option>
          <option value="REJECTED">{{ 'status.REJECTED' | translate : {} : 'Rechazado' }}</option>
        </select>
      </label>

      <!-- Observaciones -->
      <label class="label col-2">
        <span>{{ 'monthlyReview.form.fields.observations' | translate : {} : 'Observaciones' }}</span>
        <textarea class="input" rows="3" formControlName="observations"
          [placeholder]="'monthlyReview.form.placeholders.observations' | translate : {} : 'Observaciones sobre las ventas del perÔøΩodo...'"></textarea>
      </label>

      <!-- Recomendaciones -->
      <label class="label col-2">
        <span>{{ 'monthlyReview.form.fields.recommendations' | translate : {} : 'Recomendaciones' }}</span>
        <textarea class="input" rows="3" formControlName="recommendations"
          [placeholder]="'monthlyReview.form.placeholders.recommendations' | translate : {} : 'Recomendaciones o acciones a tomar...'"></textarea>
      </label>

      <!-- Botones de acciÔøΩn -->
      <div class="form-actions">
        <button class="btn success" type="submit" [disabled]="form.invalid || loading()">
          {{ isEdit()
          ? ('common.save' | translate : {} : 'Guardar')
          : ('common.create' | translate : {} : 'Crear') }}
        </button>
        <button class="btn ghost" type="button" (click)="cancel()" [disabled]="loading()">
          {{ 'common.cancel' | translate : {} : 'Cancelar' }}
        </button>
      </div>
    </form>
  </div>
</div>