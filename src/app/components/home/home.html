<div class="home">
  <!-- Efecto de part√≠culas cayendo -->
  <div class="falling-particles" aria-hidden="true">
    <div class="particle" *ngFor="let p of [].constructor(30); let i = index" [style.--delay]="i * 0.3 + 's'"></div>
  </div>

  <div class="layout" [class.logged-in]="isLoggedIn() && !showAuthPanel">
    <!-- IZQUIERDA: Panel Auth -->
    <section *ngIf="showAuthPanel" class="auth-panel glass" [class.mode-login]="mode()==='login'"
      [class.mode-register]="mode()==='register'" [class.hiding]="hiding" [class.enter]="entering"
      [style.--split]="mode()==='login' ? '64%' : '36%'" aria-label="Authentication">

      <!-- Tab switcher (ARIA Tabs Pattern) -->
      <div class="auth-tabs" role="tablist" aria-label="Opciones de autenticaci√≥n">
        <button
          type="button"
          role="tab"
          class="auth-tab"
          [class.active]="mode()==='login'"
          [attr.aria-selected]="mode()==='login'"
          [attr.tabindex]="mode()==='login' ? 0 : -1"
          aria-controls="login-panel"
          id="login-tab-btn"
          (click)="setMode('login')"
          data-cy="login-tab">
          <span class="tab-icon" aria-hidden="true">üîê</span>
          <span class="tab-text">{{ 'auth.login.title' | translate }}</span>
        </button>
        <button
          type="button"
          role="tab"
          class="auth-tab"
          [class.active]="mode()==='register'"
          [attr.aria-selected]="mode()==='register'"
          [attr.tabindex]="mode()==='register' ? 0 : -1"
          aria-controls="register-panel"
          id="register-tab-btn"
          (click)="setMode('register')"
          data-cy="register-tab">
          <span class="tab-icon" aria-hidden="true">‚ú®</span>
          <span class="tab-text">{{ 'auth.register.title' | translate }}</span>
        </button>
      </div>

      <!-- üì± Mobile tab switcher (same ARIA pattern) -->
      <div class="mobile-auth-tabs" role="tablist" aria-label="Opciones de autenticaci√≥n m√≥vil">
        <button
          type="button"
          role="tab"
          class="mobile-tab"
          [class.active]="mode()==='login'"
          [attr.aria-selected]="mode()==='login'"
          [attr.tabindex]="mode()==='login' ? 0 : -1"
          aria-controls="login-panel"
          (click)="setMode('login')">
          <span class="tab-icon" aria-hidden="true">üîê</span>
          <span class="tab-text">{{ 'auth.login.title' | translate }}</span>
        </button>
        <button
          type="button"
          role="tab"
          class="mobile-tab"
          [class.active]="mode()==='register'"
          [attr.aria-selected]="mode()==='register'"
          [attr.tabindex]="mode()==='register' ? 0 : -1"
          aria-controls="register-panel"
          (click)="setMode('register')">
          <span class="tab-icon" aria-hidden="true">‚ú®</span>
          <span class="tab-text">{{ 'auth.register.title' | translate }}</span>
        </button>
      </div>

      <div class="auth-body">
        <!-- LOGIN PANEL -->
        <div class="auth-half left"
          role="tabpanel"
          id="login-panel"
          aria-labelledby="login-tab-btn"
          [class.active]="mode()==='login'"
          [attr.hidden]="mode()!=='login' ? true : null">

          <!-- üîÑ Banner de espera de verificaci√≥n (cuando est√° esperando que el usuario verifique desde otra pesta√±a) -->
          <div class="verification-standalone" *ngIf="waitingForVerification() && mode()==='login' && !loadingLogin"
            (click)="$event.stopPropagation()">
            <div class="waiting-verification-large" role="status">
              <div class="spinner-large"></div>
              <div class="waiting-content-large">
                <strong>{{ 'home.verification.waiting.title' | translate }}</strong>
                <p>{{ 'home.verification.waiting.message' | translate }}</p>

                <!-- Bot√≥n de reenv√≠o con temporizador -->
                <button type="button" class="btn-resend-large" (click)="resendVerificationEmailFromHome()"
                  [disabled]="resendingEmail() || !canResend()">
                  <span *ngIf="resendingEmail()">
                    ‚è≥ {{ 'home.verification.resend.sending' | translate }}<span class="dots">...</span>
                  </span>
                  <span *ngIf="!resendingEmail() && !canResend()">
                    üìß {{ 'home.verification.resend.buttonWithTimer' | translate:{ seconds: resendCooldown() } }}
                  </span>
                  <span *ngIf="!resendingEmail() && canResend()">
                    üìß {{ 'home.verification.resend.button' | translate }}
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- ‚úÖ Banner de verificaci√≥n STANDALONE (reemplaza el formulario cuando est√° activo) -->
          <div class="verification-standalone" *ngIf="needsEmailVerification() && mode()==='login' && !waitingForVerification()"
            (click)="$event.stopPropagation()">
            <div class="verification-banner-large" role="alert">
              <div class="banner-icon-large">‚ö†Ô∏è</div>
              <div class="banner-content-large">
                <div class="banner-header-large">
                  <strong>{{ 'home.verification.unverified.title' | translate }}</strong>
                  <button type="button" class="banner-close" (click)="needsEmailVerification.set(false)"
                    [attr.aria-label]="'home.verification.unverified.close' | translate"
                    [attr.title]="'home.verification.unverified.close' | translate">
                    ‚úï
                  </button>
                </div>
                <p class="banner-text-large">
                  {{ 'home.verification.unverified.message' | translate }}
                </p>

                <!-- Mensaje de email enviado -->
                <div class="banner-success-large" *ngIf="emailSent()">
                  <span class="success-icon">‚úì</span>
                  <strong>{{ 'home.verification.sent.title' | translate }}</strong>
                  <p>{{ 'home.verification.sent.message' | translate }}</p>
                </div>

                <!-- Mensaje cuando NO se ha enviado a√∫n -->
                <div class="banner-info-large" *ngIf="!emailSent()">
                  <p><strong>{{ 'home.verification.notReceived.question' | translate }}</strong> {{ 'home.verification.notReceived.instruction' | translate }}</p>
                </div>

                <!-- Bot√≥n de reenv√≠o con temporizador -->
                <button type="button" class="btn-resend-large" (click)="resendVerificationEmailFromHome()"
                  [disabled]="resendingEmail() || !canResend()">
                  <span *ngIf="resendingEmail()">
                    ‚è≥ {{ 'home.verification.resend.sending' | translate }}<span class="dots">...</span>
                  </span>
                  <span *ngIf="!resendingEmail() && !canResend()">
                    üìß {{ 'home.verification.resend.buttonWithTimer' | translate:{ seconds: resendCooldown() } }}
                  </span>
                  <span *ngIf="!resendingEmail() && canResend() && emailSent()">
                    üìß {{ 'home.verification.resend.buttonAgain' | translate }}
                  </span>
                  <span *ngIf="!resendingEmail() && canResend() && !emailSent()">
                    üìß {{ 'home.verification.resend.buttonSend' | translate }}
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- Formulario LOGIN (solo visible si NO hay banner de verificaci√≥n) -->
          <form class="auth-form" *ngIf="!needsEmailVerification() || mode()!=='login'" [formGroup]="loginForm"
            (ngSubmit)="submitLogin()" (click)="$event.stopPropagation()">
            <h2>{{ 'auth.login.title' | translate }}</h2>

            <label>
              <span>{{ 'auth.fields.emailOrUsername' | translate : {} : 'Email o Usuario' }}</span>
              <input type="text" formControlName="email" [attr.placeholder]="mode() === 'login' && emailAnimOn() ? animatedPlaceholder : ''"
                [attr.data-anim]="mode() === 'login' && emailAnimOn() ? 'on' : 'off'" autocomplete="username" required
                [class.star-wars-placeholder]="mode() === 'login' && emailAnimOn()" (focus)="onEmailFocus()"
                (blur)="onEmailBlur()" data-cy="email-input" />
            </label>

            <label>
              <span>{{ 'auth.fields.password' | translate }}</span>
              <div class="input-with-toggle">
                <input [type]="showLoginPwd ? 'text' : 'password'" formControlName="password"
                  [attr.placeholder]="mode() === 'login' && passwordAnimOn() ? animatedPasswordPlaceholder : ''"
                  [attr.data-anim]="mode() === 'login' && passwordAnimOn() ? 'on' : 'off'"
                  [class.star-wars-placeholder]="mode() === 'login' && passwordAnimOn()"
                  (focus)="onPasswordFocus()"
                  (blur)="onPasswordBlur()"
                  autocomplete="current-password"
                  required data-cy="password-input" />
                <button type="button" class="pwd-toggle" (click)="showLoginPwd = !showLoginPwd"
                  [attr.aria-label]="showLoginPwd ? ('home.password.hide' | translate) : ('home.password.show' | translate)"
                  [attr.title]="showLoginPwd ? ('home.password.hide' | translate) : ('home.password.show' | translate)">
                  <span class="material-symbols-outlined">{{ showLoginPwd ? 'visibility' : 'visibility_off' }}</span>
                </button>
              </div>
            </label>

            <div class="forgot-password-link">
              <a routerLink="/forgot-password">{{ 'auth.login.forgot_password' | translate }}</a>
            </div>

            <button type="submit" [disabled]="loadingLogin" class="btn-main" [class.is-loading]="loadingLogin" data-cy="login-button">
              <span class="btn-label">{{ 'auth.login.submit' | translate }}</span>
              <span class="spinner" *ngIf="loadingLogin" aria-hidden="true"></span>
            </button>

            <p class="auth-error" *ngIf="errorLogin && !needsEmailVerification()">
              {{ errorLogin }}
            </p>
          </form>
        </div>

        <!-- Divisi√≥n -->
        <div class="auth-divider" aria-hidden="true"></div>

        <!-- REGISTER PANEL -->
        <div class="auth-half right"
          role="tabpanel"
          id="register-panel"
          aria-labelledby="register-tab-btn"
          [class.active]="mode()==='register'"
          [attr.hidden]="mode()!=='register' ? true : null">

          <!-- üîÑ Banner de espera de verificaci√≥n en REGISTRO (cuando est√° esperando que el usuario verifique desde otra pesta√±a) -->
          <div class="verification-standalone" *ngIf="waitingForVerification() && mode()==='register' && !loadingRegister"
            (click)="$event.stopPropagation()">
            <div class="waiting-verification-large" role="status">
              <div class="spinner-large"></div>
              <div class="waiting-content-large">
                <strong>{{ 'home.verification.waiting.title' | translate }}</strong>
                <p>{{ 'home.verification.waiting.message' | translate }}</p>

                <!-- Bot√≥n de reenv√≠o con temporizador -->
                <button type="button" class="btn-resend-large" (click)="resendVerificationEmailFromHome()"
                  [disabled]="resendingEmail() || !canResend()">
                  <span *ngIf="resendingEmail()">
                    ‚è≥ {{ 'home.verification.resend.sending' | translate }}<span class="dots">...</span>
                  </span>
                  <span *ngIf="!resendingEmail() && !canResend()">
                    üìß {{ 'home.verification.resend.buttonWithTimer' | translate:{ seconds: resendCooldown() } }}
                  </span>
                  <span *ngIf="!resendingEmail() && canResend()">
                    üìß {{ 'home.verification.resend.button' | translate }}
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- ‚úÖ Banner de verificaci√≥n STANDALONE en REGISTRO -->
          <div class="verification-standalone" *ngIf="needsEmailVerification() && mode()==='register' && !waitingForVerification()"
            (click)="$event.stopPropagation()">
            <div class="verification-banner-large" role="alert">
              <div class="banner-icon-large">‚úÖ</div>
              <div class="banner-content-large">
                <div class="banner-header-large">
                  <strong>{{ 'home.verification.success.title' | translate }}</strong>
                  <button type="button" class="banner-close" (click)="needsEmailVerification.set(false)"
                    [attr.aria-label]="'home.verification.unverified.close' | translate"
                    [attr.title]="'home.verification.unverified.close' | translate">
                    ‚úï
                  </button>
                </div>
                <p class="banner-text-large">
                  {{ 'home.verification.success.message' | translate }}
                </p>

                <div class="banner-success-large" *ngIf="emailSent()">
                  <span class="success-icon">‚úì</span>
                  {{ 'home.verification.success.sent' | translate }}
                </div>

                <div class="banner-info-large">
                  <p>{{ 'home.verification.success.info' | translate }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Formulario REGISTRO (solo visible si NO hay banner de verificaci√≥n) -->
          <form class="auth-form" *ngIf="!needsEmailVerification() || mode()!=='register'" [formGroup]="registerForm"
            (ngSubmit)="submitRegister()" (click)="$event.stopPropagation()">
            <h2>{{ 'auth.register.title' | translate }}</h2>

            <label>
              <span>{{ 'auth.fields.username' | translate }}</span>
              <input type="text" formControlName="username"
                [attr.placeholder]="mode() === 'register' && nameAnimOn() ? animatedNamePlaceholder : ''"
                [attr.data-anim]="mode() === 'register' && nameAnimOn() ? 'on' : 'off'" autocomplete="off" required
                [class.star-wars-placeholder]="mode() === 'register' && nameAnimOn()" (focus)="onNameFocus()"
                (blur)="onNameBlur()" data-cy="name-input" />
            </label>

            <label>
              <span>{{ 'auth.fields.email' | translate }}</span>
              <input type="email" formControlName="email" [attr.placeholder]="mode() === 'register' && emailAnimOn() ? animatedPlaceholder : ''"
                [attr.data-anim]="mode() === 'register' && emailAnimOn() ? 'on' : 'off'" autocomplete="email" required
                [class.star-wars-placeholder]="mode() === 'register' && emailAnimOn()" (focus)="onEmailFocus()"
                (blur)="onEmailBlur()" data-cy="email-input" />
            </label>

            <label>
              <span>{{ 'auth.fields.password' | translate }}</span>
              <div class="input-with-toggle">
                <input [type]="showRegisterPwd ? 'text' : 'password'" formControlName="password"
                  [attr.placeholder]="mode() === 'register' && passwordAnimOn() ? animatedPasswordPlaceholder : ''"
                  [attr.data-anim]="mode() === 'register' && passwordAnimOn() ? 'on' : 'off'"
                  [class.star-wars-placeholder]="mode() === 'register' && passwordAnimOn()"
                  (focus)="onRegisterPasswordFocus()"
                  (blur)="onRegisterPasswordBlur()"
                  autocomplete="new-password" required data-cy="password-input" />
                <button type="button" class="pwd-toggle" (click)="showRegisterPwd = !showRegisterPwd"
                  [attr.aria-label]="showRegisterPwd ? ('home.password.hide' | translate) : ('home.password.show' | translate)"
                  [attr.title]="showRegisterPwd ? ('home.password.hide' | translate) : ('home.password.show' | translate)">
                  <span class="material-symbols-outlined">{{ showRegisterPwd ? 'visibility' : 'visibility_off' }}</span>
                </button>
              </div>
              <!-- Mensaje de requisitos de contrase√±a -->
              <div class="password-requirements" *ngIf="showRegisterPasswordRequirements">
                <p class="requirements-title">{{ 'auth.password_requirements.title' | translate }}</p>
                <ul class="requirements-list">
                  <li [class.met]="passwordHasMinLength()">{{ 'auth.password_requirements.min_length' | translate }}</li>
                  <li [class.met]="passwordHasUppercase()">{{ 'auth.password_requirements.uppercase' | translate }}</li>
                  <li [class.met]="passwordHasLowercase()">{{ 'auth.password_requirements.lowercase' | translate }}</li>
                  <li [class.met]="passwordHasNumber()">{{ 'auth.password_requirements.number' | translate }}</li>
                  <li [class.met]="passwordHasSpecial()">{{ 'auth.password_requirements.special' | translate }}</li>
                </ul>
              </div>
            </label>

            <button type="submit" [disabled]="loadingRegister" data-cy="register-button">{{ 'auth.register.submit' | translate }}</button>

            <p class="auth-error" *ngIf="errorRegister">
              {{ errorRegister }}
            </p>
          </form>
        </div>
      </div>
    </section>

    <!-- DERECHA: Brand / Bienvenida -->
    <section class="brand-plain" [class.is-logged]="isLoggedIn() && !showAuthPanel" aria-label="Branding">
      <div class="welcome-badge" *ngIf="isLoggedIn() && !showAuthPanel">
        <span class="wave" aria-hidden="true">üëã</span>
        <span>{{ 'home.welcome' | translate }} <strong>{{ user()?.username || ('auth.user' | translate)
            }}</strong></span>
      </div>

      <div class="brand-head">
        <h1 class="wordmark">GarrSYS</h1>
        <img *ngIf="logoOk" class="logo" src="/logo-dark.svg" alt="GarrSYS" (error)="onLogoError()" />
        <span *ngIf="!logoOk" class="logo-fallback" aria-hidden="true">GS</span>
      </div>

      <p class="tagline">{{ 'home.tagline' | translate }}</p>
    </section>
  </div>

  <!-- ‚úÖ INTRODUCCI√ìN con CARDS EXPANDIBLES - DISE√ëO ORIGINAL RESTAURADO -->
  <section class="intro-v2" id="intro-panel" aria-labelledby="intro-title">
    <div class="intro-shell">
      <div class="intro-header">
        <span class="pill">{{ 'home.pill' | translate }}</span>
        <h3 id="intro-title">{{ 'home.intro.title' | translate }}</h3>
        <p class="lead">{{ 'home.intro.lead' | translate }}</p>
      </div>

      <div class="intro-grid">
        <button class="intro-card" type="button" *ngFor="let it of introItems; let i = index"
          (click)="toggleFlip(i, $event)" (keydown)="onCardKey(i, $event)" [class.expanded]="flipped.has(i)"
          [attr.aria-expanded]="flipped.has(i) ? 'true' : 'false'" [attr.aria-label]="it.titleKey | translate">
          <div class="card-surface">
            <header class="card-head">
              <span class="tiny-logo" aria-hidden="true"></span>
              <h4 class="card-title">{{ it.titleKey | translate }}</h4>
              <span class="chev" aria-hidden="true"></span>
            </header>
            <div class="card-detail">
              <p class="detail">{{ it.detailKey | translate }}</p>
            </div>
          </div>
        </button>
      </div>
    </div>
  </section>
</div>