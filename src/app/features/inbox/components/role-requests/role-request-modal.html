<!-- role-request-modal.component.html - Versi√≥n mejorada -->
<div *ngIf="isOpen" class="modal-overlay" (click)="onOverlayClick($event)">
  <div class="modal role-request-modal glass-modal" (click)="$event.stopPropagation()">

    <!-- Header mejorado -->
    <div class="modal-header">
      <div class="header-content">
        <div class="step-indicator" *ngIf="requiresAdditionalData">
          <span class="step" [class.active]="currentStep === 1">1</span>
          <div class="step-divider" [class.completed]="currentStep === 2"></div>
          <span class="step" [class.active]="currentStep === 2" [class.completed]="currentStep === 2">2</span>
        </div>
        <div>
          <h2>
            {{ currentStep === 1
            ? ('roleRequests.modal.title' | translate)
            : ('roleRequests.modal.additionalDataTitle' | translate)
            }}
          </h2>
          <p class="subtitle" *ngIf="currentStep === 1">
            {{ 'roleRequests.modal.selectRole' | translate }}
          </p>
          <p class="subtitle" *ngIf="currentStep === 2">
            {{ 'roleRequests.modal.completeDataFor' | translate }} {{ getRoleInfo(requestedRole)?.label || 'el rol' }}
          </p>
        </div>
      </div>
      <button class="close-btn" type="button" (click)="onClose()" [disabled]="isSubmitting">√ó</button>
    </div>

    <!-- ========== PASO 1: Selecci√≥n de Rol ========== -->
    <form *ngIf="currentStep === 1" (ngSubmit)="goToStep2()" class="modal-body">

      <!-- Error message con dise√±o mejorado -->
      <div *ngIf="error" class="alert alert-error">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div class="alert-content">
          <strong>{{ 'roleRequests.modal.error' | translate }}</strong>
          <p>{{ error }}</p>
        </div>
      </div>

    

      <!-- Roles Grid - Dise√±o de tarjetas mejorado -->
      <div class="form-section">
        <label class="section-label">
          <span class="icon">üéØ</span>
          {{ 'roleRequests.modal.requestedRole' | translate }}
          <span class="required">*</span>
        </label>

        <div class="roles-grid">
          <label
            *ngFor="let role of availableRoles"
            class="role-card"
            [class.selected]="requestedRole === role.value"
            [class.disabled]="isSubmitting"
          >
            <input
              type="radio"
              name="requestedRole"
              [value]="role.value"
              [(ngModel)]="requestedRole"
              (change)="onRequestedRoleChange()"
              [disabled]="isSubmitting"
              class="sr-only"
            />
            <div class="role-card-content">
              <div class="role-icon">{{ role.icon }}</div>
              <div class="role-info">
                <h3 class="role-title">{{ role.label }}</h3>
                <p class="role-description">{{ role.description }}</p>
              </div>
              <div class="role-check">
                <span class="checkmark">‚úì</span>
              </div>
            </div>
          </label>
        </div>

        <!-- Empty state cuando no hay roles disponibles -->
        <div *ngIf="availableRoles.length === 0" class="empty-state-small">
          <span class="icon">‚ÑπÔ∏è</span>
          <p>
            {{ isRoleChange
              ? ('roleRequests.modal.selectRoleFirst' | translate)
              : ('roleRequests.modal.noRolesAvailable' | translate)
            }}
          </p>
        </div>
      </div>

      <!-- Role to Remove - Solo si se detect√≥ incompatibilidad o el usuario activ√≥ el toggle -->
      <!-- ‚úÖ NO mostrar para AUTHORITY ya que remueve TODOS los roles autom√°ticamente -->
      <div *ngIf="isRoleChange && removableRoles.length > 0 && requestedRole !== 'AUTHORITY'" class="form-section">
        <label class="section-label">
          <span class="icon">üîª</span>
          {{ 'roleRequests.modal.roleToRemoveRequired' | translate }}
          <span class="required">*</span>
        </label>

        <div class="roles-grid">
          <label
            *ngFor="let role of removableRoles"
            class="role-card role-card-small"
            [class.selected]="roleToRemove === role"
            [class.disabled]="isSubmitting"
          >
            <input
              type="radio"
              name="roleToRemove"
              [value]="role"
              [(ngModel)]="roleToRemove"
              [disabled]="isSubmitting"
              class="sr-only"
            />
            <div class="role-card-content">
              <div class="role-icon-small">{{ getRoleInfo(role)?.icon }}</div>
              <div class="role-info">
                <h4 class="role-title-small">{{ getRoleInfo(role)?.label || role }}</h4>
              </div>
              <div class="role-check">
                <span class="checkmark">‚úì</span>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Toggle manual de cambio de rol (solo si no hay auto-detecci√≥n) -->
      <div *ngIf="!autoDetectedIncompatibility && removableRoles.length > 0" class="form-section">
        <label class="toggle-label">
          <input
            type="checkbox"
            [(ngModel)]="isRoleChange"
            name="isRoleChange"
            (change)="onRoleChangeToggle(isRoleChange)"
            class="toggle-input"
          />
          <span class="toggle-slider"></span>
          <div class="toggle-text">
            <strong>{{ 'roleRequests.modal.changeToggle' | translate }}</strong>
            <p class="help-text">{{ 'roleRequests.modal.changeHelp' | translate }}</p>
          </div>
        </label>
      </div>

      <!-- Justificaci√≥n -->
      <div class="form-section">
        <label class="section-label">
          <span class="icon">üí≠</span>
          {{ 'roleRequests.modal.justification' | translate }}
          <span class="optional">{{ 'roleRequests.modal.justificationOptional' | translate }}</span>
        </label>

        <div class="textarea-wrapper">
          <textarea
            id="justification"
            [(ngModel)]="justification"
            name="justification"
            [placeholder]="'roleRequests.modal.justificationPh' | translate"
            [disabled]="isSubmitting"
            minlength="20"
            maxlength="500"
            rows="4"
            class="textarea-input"
          ></textarea>
          <div class="textarea-footer">
            <span class="character-count">
              {{ justification.length }} / 500
            </span>
            <span *ngIf="justification.length > 0 && justification.length < 20" class="validation-hint error">
              {{ 'roleRequests.modal.minCharacters' | translate }}
            </span>
            <span *ngIf="justification.length >= 20" class="validation-hint success">
              {{ 'roleRequests.modal.valid' | translate }}
            </span>
          </div>
        </div>
      </div>

      <!-- Info box - Incompatibilidades 
      <div *ngIf="incompatibleRolesText && requestedRole" class="info-box warning">
        <span class="info-icon">‚ö†Ô∏è</span>
        <div class="info-content">
          <strong>Roles Incompatibles</strong>
          <p>
            El rol <strong>{{ getRoleInfo(requestedRole)?.label }}</strong> no puede combinarse con:
            <strong>{{ incompatibleRolesText }}</strong>
          </p>
        </div>
      </div>-->

      <!-- Acciones Paso 1 -->
      <div class="modal-actions">
        <button
          type="button"
          class="btn btn-cancel"
          (click)="onClose()"
          [disabled]="isSubmitting"
        >
          <span class="btn-icon">‚úï</span>
          {{ 'roleRequests.modal.actions.cancel' | translate }}
        </button>

        <button
          type="submit"
          class="btn btn-submit"
          [disabled]="isSubmitting || !requestedRole || (isRoleChange && !roleToRemove) ||
                      (justification.length > 0 && justification.length < 20)"
        >
          <span class="btn-icon" *ngIf="!isSubmitting">
            {{ requiresAdditionalData ? '‚Üí' : '‚úì' }}
          </span>
          <span class="spinner-small" *ngIf="isSubmitting"></span>
          {{ requiresAdditionalData
            ? ('roleRequests.modal.continue' | translate)
            : (isSubmitting
              ? ('roleRequests.modal.actions.sending' | translate)
              : ('roleRequests.modal.actions.submit' | translate))
          }}
        </button>
      </div>
    </form>

    <!-- ========== PASO 2: Datos Adicionales ========== -->
    <form *ngIf="currentStep === 2" (ngSubmit)="onSubmit()" class="modal-body">

      <!-- Error message -->
      <div *ngIf="error" class="alert alert-error">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div class="alert-content">
          <strong>{{ 'roleRequests.modal.error' | translate }}</strong>
          <p>{{ error }}</p>
        </div>
      </div>

      

      <!-- ========== Datos para DISTRIBUTOR ========== -->
      <ng-container *ngIf="requestedRole === 'DISTRIBUTOR'">
        <div class="form-section">
          <label class="section-label">
            <span class="icon">üìç</span>
            {{ 'roleRequests.modal.distributor.zone' | translate }}
            <span class="required">*</span>
          </label>

          <select
            id="distZone"
            [(ngModel)]="roleSpecificData.distributorZoneId"
            name="distZone"
            [disabled]="isSubmitting || loadingCatalogs"
            required
            class="select-input"
          >
            <option [ngValue]="null">{{ 'roleRequests.modal.distributor.selectZone' | translate }}</option>
            <option *ngFor="let zone of zones" [ngValue]="zone.id">
              <span class="zone-id">#{{ zone.id }}</span> {{ zone.name }}
            </option>
          </select>
          <p class="help-text">{{ 'roleRequests.modal.distributor.zoneHelp' | translate }}</p>
        </div>

        <div class="form-section">
          <label class="section-label">
            <span class="icon">üè†</span>
            {{ 'roleRequests.modal.distributor.address' | translate }}
            <span class="required">*</span>
          </label>

          <input
            type="text"
            id="distAddress"
            [(ngModel)]="roleSpecificData.distributorAddress"
            name="distAddress"
            [disabled]="isSubmitting"
            [placeholder]="'roleRequests.modal.distributor.addressPlaceholder' | translate"
            required
            class="text-input"
          />
          <p class="help-text">{{ 'roleRequests.modal.distributor.addressHelp' | translate }}</p>
        </div>


      </ng-container>

      <!-- ========== Datos para AUTHORITY ========== -->
      <ng-container *ngIf="requestedRole === 'AUTHORITY'">
        <div class="form-section">
          <label class="section-label">
            <span class="icon">‚≠ê</span>
            {{ 'roleRequests.modal.authority.rank' | translate }}
            <span class="required">*</span>
          </label>

          <select
            id="authRank"
            [(ngModel)]="roleSpecificData.authorityRank"
            name="authRank"
            [disabled]="isSubmitting"
            required
            class="select-input"
          >
            <option [ngValue]="null">{{ 'roleRequests.modal.authority.selectRank' | translate }}</option>
            <option *ngFor="let rank of AUTHORITY_RANKS" [ngValue]="rank.value">
              {{ rank.label }}
            </option>
          </select>
          <p class="help-text">{{ 'roleRequests.modal.authority.rankHelp' | translate }}</p>
        </div>

        <div class="form-section">
          <label class="section-label">
            <span class="icon">üìç</span>
            {{ 'roleRequests.modal.authority.zone' | translate }}
            <span class="required">*</span>
          </label>

          <select
            id="authZone"
            [(ngModel)]="roleSpecificData.authorityZoneId"
            name="authZone"
            [disabled]="isSubmitting || loadingCatalogs"
            required
            class="select-input"
          >
            <option [ngValue]="null">{{ 'roleRequests.modal.authority.selectZone' | translate }}</option>
            <option *ngFor="let zone of zones" [ngValue]="zone.id">
              #{{ zone.id }} - {{ zone.name }}
            </option>
          </select>
          <p class="help-text">{{ 'roleRequests.modal.authority.zoneHelp' | translate }}</p>
        </div>
      </ng-container>

      <!-- Acciones Paso 2 -->
      <div class="modal-actions">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="backToStep1()"
          [disabled]="isSubmitting"
        >
          <span class="btn-icon">‚Üê</span>
          {{ 'roleRequests.modal.actions.back' | translate }}
        </button>

        <button
          type="submit"
          class="btn btn-submit"
          [disabled]="isSubmitting || !additionalDataValid"
        >
          <span class="btn-icon" *ngIf="!isSubmitting">‚úì</span>
          <span class="spinner-small" *ngIf="isSubmitting"></span>
          {{ isSubmitting
            ? ('roleRequests.modal.actions.sending' | translate)
            : ('roleRequests.modal.actions.submit' | translate)
          }}
        </button>
      </div>
    </form>
  </div>
</div>
